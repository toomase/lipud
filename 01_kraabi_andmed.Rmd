---
title: "Riikide nimekiri ja lipud"
output: html_notebook
---

Kraabi kõigi maailma riikide nimekiri ja nende lippude url. Pane tulemustest kokku data frame, mida kasutan shiny apis.

```{r}
library(rvest)
library(tidyverse)
library(splitstackshape)
```

Wikipiedia leht koos riikide nimekirjaga ja lippudega
```{r}
riigid_url <- "https://et.wikipedia.org/wiki/ISO_maakoodide_loend"
```

Riikide nimed ja lipu pildi url
```{r}
wiki_leht <- read_html(riigid_url)

riigid <- wiki_leht %>% 
  html_nodes("td:nth-child(1) a") %>% 
  html_text() %>%
  data_frame(riik = .) %>% 
  filter(riik != "", riik != "Antarktis")

lipud <- wiki_leht %>% 
  html_nodes(".thumbborder") %>% 
  html_attr('src')
```

Ühes tabelis riikide nimekiri ja lipu url shiny tabelis kuvamise formaadis
```{r}
riigid_lippudega_raw <- riigid %>% 
  mutate(lipu_url = lipud,
         lipp = str_c('<img src=\"https:', lipu_url, '\" ></img>'),
         laenutaja = as.character(NA),
         algus_kp = as.character(NA),
         lopp_kp = as.character(NA),
         tagastamise_kp = as.character(NA),
         id = as.character(row_number())) %>% 
  select(id, lipp, riik, laenutaja, algus_kp, lopp_kp, tagastamise_kp)

# kuva selliselt, nagu shiny äpis
DT::datatable(riigid_lippudega_raw, escape = FALSE)
```

Kuna ühte lipu võib olla laos mitu tükki, siis tekita näidis andmed.
Iga lipp saab ka unikaalse id.
```{r}
riigid_lippudega <- riigid_lippudega_raw %>%
  mutate(mitu_lippu = case_when(riik == "Läti" ~ 4,
                                riik == "Soome" ~ 6,
                                riik == "Rootsi" ~ 3,
                                TRUE ~ 1),
         mitu_lippu_2 = mitu_lippu) %>% 
  expandRows("mitu_lippu") %>%  # korda ridu nii mitu korda, kui palju vastavat lippu laos on
  mutate(id_2 = id) %>% 
  group_by(id_2) %>% 
  mutate(id = ifelse(mitu_lippu_2 > 1, str_c(id, row_number(), sep = "-"), id),
         riik = ifelse(mitu_lippu_2 > 1, str_c(riik, row_number(), sep = "-"), riik)) %>% 
  ungroup() %>% 
  select(-id_2, -mitu_lippu_2)
```


Salvesta tulemus
```{r}
# save(riigid_lippudega, file = "data/riigid_lippudega.RData")
```

Salvesta csv äpis kasutamiseks
```{r}
write_csv(riigid_lippudega, "lipud/responses/riigid_lippudega.csv")
```

